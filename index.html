<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Protox Whiteboard</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* Reset & Base */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:sans-serif;overflow:hidden;background:#f5f5f5;user-select:none}
/* Canvas */
#c{position:absolute;top:0;left:0;cursor:crosshair;touch-action:none}
/* Toolbar */
.tb{position:fixed;top:15px;left:50%;transform:translateX(-50%);background:#fff;padding:6px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);display:flex;gap:8px;z-index:100}
.btn{width:36px;height:36px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center}
.btn:hover{background:#f0f7ff;border-color:#4a90e2}
.btn.on{background:#4a90e2;color:#fff;border-color:#4a90e2}
.sep{width:1px;height:24px;background:#ddd;align-self:center}
/* Inputs */
input[type=color]{width:30px;height:30px;border:none;cursor:pointer;background:none}
input[type=range]{width:80px;cursor:pointer}
/* Notes & Text */
.sn{position:absolute;width:200px;background:#feff9c;box-shadow:0 4px 10px rgba(0,0,0,0.2);border-radius:4px;z-index:10}
.sh{height:24px;background:rgba(0,0,0,0.05);cursor:move;display:flex;justify-content:flex-end;padding:2px}
.close{background:#ff5555;color:white;border:none;width:20px;border-radius:50%;cursor:pointer;font-weight:bold}
textarea{width:100%;height:120px;border:none;background:none;padding:8px;resize:vertical;outline:none}
.tx{position:absolute;background:rgba(255,255,255,0.9);border:1px solid #333;padding:2px;border-radius:4px;z-index:10}
.tx input{border:none;background:none;outline:none;font-size:16px;min-width:150px}
/* Status */
#status{position:fixed;bottom:10px;left:10px;background:white;padding:5px 10px;border-radius:20px;font-size:12px;box-shadow:0 2px 5px rgba(0,0,0,0.1);display:flex;align-items:center;gap:6px}
.dot{width:8px;height:8px;border-radius:50%;background:#ccc}
.dot.ok{background:#2ecc71} .dot.load{background:#f1c40f} .dot.err{background:#e74c3c}
</style>
</head>
<body>

<!-- TOOLBAR -->
<div class="tb">
    <button class="btn on" onclick="setT('s',this)" title="Move">‚úã</button>
    <button class="btn" onclick="setT('n',this)" title="Note">üìù</button>
    <button class="btn" onclick="setT('t',this)" title="Text">üî§</button>
    <div class="sep"></div>
    <button class="btn" onclick="setT('d',this)" title="Draw">‚úèÔ∏è</button>
    <button class="btn" onclick="setT('r',this)" title="Rect">‚¨ú</button>
    <button class="btn" onclick="setT('c',this)" title="Circle">‚≠ï</button>
    <div class="sep"></div>
    <input type="color" id="col" value="#000000">
    <input type="range" id="sz" min="1" max="20" value="3">
    <div class="sep"></div>
    <button class="btn" onclick="wipe()" title="Clear">üóëÔ∏è</button>
</div>

<div id="status"><div class="dot" id="sd"></div><span id="st">Connecting...</span></div>
<canvas id="c"></canvas>

<script>
// --- CONFIG START ---
const SB_URL = 'https://pydxnbhtibgmrqlxxwqe.supabase.co/'; 
const SB_KEY = 'sb_publishable_ntQsU9qIUGNVRNlhY9NErA_POoAFWat';
// --- CONFIG END ---

// 1. Setup & Vars
const c = document.getElementById('c'), ctx = c.getContext('2d', {alpha:false});
const col = document.getElementById('col'), sz = document.getElementById('sz');
const sd = document.getElementById('sd'), st = document.getElementById('st');
const ROOM = new URLSearchParams(location.search).get('raum') || 'lobby';

let t='s', dragging=false, panning=false, sx, sy, ox=0, oy=0, z=1, el=[], dp=[], remote=false, loaded=false;
let saveTimer;

// 2. Immediate Whiteboard Draw (Prevents Black Screen)
function resize() { c.width=innerWidth; c.height=innerHeight; draw(); }
window.onresize = resize;

// 3. Supabase Logic
const { createClient } = supabase;
const sb = createClient(SB_URL, SB_KEY);

async function init() {
    sd.className='dot load'; st.innerText='Loading ' + ROOM;
    resize(); // Draw white background immediately
    
    try {
        // Load or Create Room
        let { data, error } = await sb.from('board').select('content').eq('id', ROOM).single();
        
        if (error && error.code === 'PGRST116') {
            await sb.from('board').insert({ id: ROOM, content: {} });
            data = { content: {} };
        } else if(error) throw error;

        if (data && data.content) apply(data.content, true);
        
        loaded = true;
        sd.className='dot ok'; st.innerText='Online: ' + ROOM;

        // Realtime
        sb.channel('wb').on('postgres_changes', 
            { event: 'UPDATE', schema: 'public', table: 'board', filter: `id=eq.${ROOM}` }, 
            (p) => { if(p.new.content) { remote=true; apply(p.new.content, false); remote=false; } }
        ).subscribe();
        
    } catch (e) {
        sd.className='dot err'; st.innerText='Error (Check DB/Console)';
        console.error("Supabase Error:", e);
        alert("Fehler! Hast du Schritt 1 (SQL) ausgef√ºhrt? Schau in die Konsole (F12).");
    }
}

// 4. Drawing Logic
function draw() {
    ctx.setTransform(1,0,0,1,0,0);
    ctx.fillStyle = '#f5f5f5'; ctx.fillRect(0,0,c.width,c.height); // White Background
    ctx.translate(ox, oy); ctx.scale(z, z);
    
    // Draw Saved Elements
    el.forEach(e => {
        ctx.lineWidth = e.w; ctx.strokeStyle = e.col; ctx.fillStyle = e.col;
        ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        ctx.beginPath();
        if(e.t==='p') {
            if(e.pts.length<2)return;
            ctx.moveTo(e.pts[0].x, e.pts[0].y);
            e.pts.forEach(p=>ctx.lineTo(p.x,p.y));
            ctx.stroke();
        } else if(e.t==='r') ctx.strokeRect(e.x,e.y,e.w,e.h);
        else if(e.t==='c') {
            const r = Math.sqrt(e.w**2+e.h**2)/2;
            ctx.arc(e.x+e.w/2,e.y+e.h/2,r,0,Math.PI*2);
            ctx.stroke();
        }
    });

    // Draw Current Stroke
    if(dragging && t==='d' && dp.length>1) {
        ctx.lineWidth = parseInt(sz.value); ctx.strokeStyle = col.value;
        ctx.lineCap='round'; ctx.lineJoin='round';
        ctx.beginPath(); ctx.moveTo(dp[0].x, dp[0].y);
        dp.forEach(p=>ctx.lineTo(p.x,p.y));
        ctx.stroke();
    }
}

// 5. Sync Logic
function apply(d, force) {
    el = d.el || [];
    draw();
    
    // Sync DOM Elements (Notes/Text)
    const active = document.activeElement;
    const keep = new Set();
    
    (d.notes||[]).forEach(n => {
        keep.add(n.id);
        let div = document.querySelector(`.sn[data-id="${n.id}"]`);
        if(!div) div = domItem('sn', n.id, n.x, n.y, n.bg);
        div.style.left=n.x+'px'; div.style.top=n.y+'px'; div.style.background=n.bg;
        const ta = div.querySelector('textarea');
        if(force || active!==ta) ta.value = n.txt;
    });

    (d.texts||[]).forEach(n => {
        keep.add(n.id);
        let div = document.querySelector(`.tx[data-id="${n.id}"]`);
        if(!div) div = domItem('tx', n.id, n.x, n.y);
        div.style.left=n.x+'px'; div.style.top=n.y+'px';
        const inp = div.querySelector('input');
        if(force || active!==inp) inp.value = n.txt;
    });
    
    document.querySelectorAll('.sn,.tx').forEach(e => { if(!keep.has(e.dataset.id)) e.remove(); });
}

function save() {
    if(remote || !loaded) return;
    sd.className='dot load';
    clearTimeout(saveTimer);
    saveTimer = setTimeout(async () => {
        const notes = Array.from(document.querySelectorAll('.sn')).map(n => ({
            id: n.dataset.id, x: parseInt(n.style.left), y: parseInt(n.style.top), 
            bg: n.style.background, txt: n.querySelector('textarea').value
        }));
        const texts = Array.from(document.querySelectorAll('.tx')).map(t => ({
            id: t.dataset.id, x: parseInt(t.style.left), y: parseInt(t.style.top), 
            txt: t.querySelector('input').value
        }));
        
        await sb.from('board').update({ content: {el, notes, texts} }).eq('id', ROOM);
        sd.className='dot ok';
    }, 500);
}

// 6. Interaction
function setT(mode, btn) {
    t = mode;
    document.querySelectorAll('.btn').forEach(b => b.classList.remove('on'));
    btn.classList.add('on');
}

c.onmousedown = e => {
    sx=e.clientX; sy=e.clientY;
    const rx=(e.clientX-ox)/z, ry=(e.clientY-oy)/z;
    if(t==='s') { panning=true; c.style.cursor='grabbing'; }
    else if(t==='n') domItem('sn', null, sx, sy);
    else if(t==='t') domItem('tx', null, sx, sy);
    else { dragging=true; dp=[{x:rx,y:ry}]; }
};

c.onmousemove = e => {
    if(panning) { ox+=e.clientX-sx; oy+=e.clientY-sy; sx=e.clientX; sy=e.clientY; draw(); }
    else if(dragging) {
        const rx=(e.clientX-ox)/z, ry=(e.clientY-oy)/z;
        if(t==='d') { dp.push({x:rx,y:ry}); draw(); }
        // For rect/circle preview, we just draw logic would go here